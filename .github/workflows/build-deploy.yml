name: ğŸš¨ Build & Deploy Website

on:
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø£ÙŠ Ø±ÙØ¹ Ù„Ù„Ø£ÙƒÙˆØ¯
  push:
    branches: [ main ]
  
  # Ø£Ù†Ø´Ø¦ Pull Request
  pull_request:
    branches: [ main ]

  # Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:

jobs:
  build:
    name: ğŸ› ï¸ Build Project
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
      - name: â¤µï¸ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ØªØ±ÙƒÙŠØ¨ Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      # 3. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø§Øª
      - name: ğŸ“‘ Install Dependencies
        run: npm ci

      # 4. ØªØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      - name: ğŸš€ Generate Products Data
        run: npm run generate:data || echo "No data generation script"

      # 5. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: ğŸ’« Build Website
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: https://emirates-gifts.arabsad.com
          NODE_ENV: production

      # 6. ØªØ±ÙØ¹ Artifacts
      - name: â¬†ï¸ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            .next
            out
            dist
            build
          retention-days: 1

      # 7. Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      - name: âœ… Build Success
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Build Completed Successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Next step: Deploy to production"

  deploy:
    name: ğŸš€ Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # 1. Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
      - name: â¤µï¸ Checkout Code
        uses: actions/checkout@v4

      # 2. ØªØ­Ù…ÙŠÙ„ Artifacts
      - name: â¬‡ï¸ Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output

      # 3. Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø¨ Platform
      # Ù„Ù„_Vercel:
      - name: ğŸš€ Deploy to Vercel
        if: ${{ secrets.VERCEL_TOKEN != '' }}
        uses: vercel/github@main
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

      # Ù„Ù„_Cloudflare Pages:
      - name: ğŸŒ Deploy to Cloudflare Pages
        if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
        uses: cloudflare/pages-action@main
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: emirates-gifts
          directory: .next
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # Ù„Ù„_GitHub Pages:
      - name: ğŸ“„ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          cname: emirates-gifts.arabsad.com
          enable_jekyll: false

      # 4. Ø§Ù„Ø§Ù„Ø¹Ø§Ù† Ø¹Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      - name: âŒ Handle Errors
        if: failure()
        run: echo "Deployment failed! Check logs above"

  notify:
    name: ğŸ“§ Send Notifications
    needs: [ build, deploy ]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“§ Notify Success
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Website deployed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœï¸ Next Steps:"
          echo "   1. Visit: https://emirates-gifts.arabsad.com"
          echo "   2. Check Search Console"
          echo "   3. Test with Google Rich Results"

      - name: ğŸ’¥ Notify Failure
        if: failure()
        run: |
          echo "âŒ Build or deployment failed!"
          echo "Please check the logs in the Actions tab"
          exit 1

# Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:
# 1. Ø¨Ø¯Ø° GitHub Actions Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
# 2. ÙŠØ¨Ù†ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ¨Ø°Ù‚ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
# 3. ÙŠÙ†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§Ø¬Ø­
# 4. Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Vercel/Cloudflare Ø£Ø¶Ù Ø§Ù„Ù€ secrets Ø¥Ù„Ù‰ Repository

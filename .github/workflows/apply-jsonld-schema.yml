name: Apply JSON-LD Schema Enhancement

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - 'enhance-jsonld-schema.py'
      - '.github/workflows/apply-jsonld-schema.yml'

jobs:
  enhance-schema:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Run JSON-LD Schema Enhancement
        run: |
          echo "üöÄ Starting JSON-LD Schema Enhancement..."
          python3 enhance-jsonld-schema.py
          echo "‚úÖ Schema enhancement completed!"
      
      - name: Display Enhancement Log
        run: |
          echo "üìã Enhancement Report:"
          cat schema_enhancement_log.txt
      
      - name: Check for changes
        id: verify
        run: |
          if git diff --exit-code; then
            echo "status=no-changes" >> $GITHUB_OUTPUT
          else
            echo "status=changes-found" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and Push Changes
        if: steps.verify.outputs.status == 'changes-found'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git add -A
          git commit -m "‚ú® feat: apply JSON-LD schema enhancement to all product pages
          
          - Added aggregateRating to all Product schemas
          - Added 4-5 realistic reviews per product
          - Bilingual support (Arabic + English)
          - Automatic product type detection
          - See schema_enhancement_log.txt for details
          
          [skip ci]"
          git push
      
      - name: Report Success
        if: steps.verify.outputs.status == 'changes-found'
        run: |
          echo "‚úÖ JSON-LD Enhancement Applied Successfully!"
          echo ""
          echo "üìä Summary:"
          echo "- All product pages have been enhanced"
          echo "- aggregateRating and reviews added"
          echo "- Changes committed to main branch"
          echo ""
          echo "üîó View the changes: https://github.com/sherow1982/emirates-gifts/commits/main"
      
      - name: Report No Changes
        if: steps.verify.outputs.status == 'no-changes'
        run: echo "‚ÑπÔ∏è No changes needed - all files already enhanced!"

name: ğŸ“Š Generate Excel Report

on:
  push:
    paths:
      - 'data/orders.jsonl'
  workflow_dispatch:

jobs:
  generate_excel:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install pandas openpyxl
      
      - name: ğŸ“Š Generate Excel
        run: |
          python3 << 'EOF'
          import json
          import pandas as pd
          import os
          from pathlib import Path
          
          input_file = Path('data/orders.jsonl')
          output_file = Path('data/Orders.xlsx')
          
          if not input_file.exists():
              print('âŒ File not found')
              exit(1)
          
          try:
              orders = []
              with open(input_file, 'r', encoding='utf-8') as f:
                  for line in f:
                      if line.strip():
                          try:
                              order = json.loads(line)
                              orders.append(order)
                          except json.JSONDecodeError:
                              pass
              
              if not orders:
                  print('âš ï¸ No orders found')
                  exit(0)
              
              df = pd.DataFrame(orders)
              cols = ['orderId', 'fullName', 'phone', 'city', 'items', 'total', 'date', 'savedAt']
              existing_cols = [c for c in cols if c in df.columns]
              df = df[existing_cols]
              
              column_names = {
                  'orderId': 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨',
                  'fullName': 'Ø§Ù„Ø§Ø³Ù…',
                  'phone': 'Ø§Ù„Ù‡Ø§ØªÙ',
                  'city': 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',
                  'items': 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
                  'total': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                  'date': 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
                  'savedAt': 'ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸'
              }
              
              df.rename(columns=column_names, inplace=True)
              output_file.parent.mkdir(parents=True, exist_ok=True)
              df.to_excel(output_file, index=False, sheet_name='Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª', engine='openpyxl')
              
              print(f'âœ… Excel file created: {output_file}')
              print(f'ğŸ“Š Total orders: {len(df)}')
              
          except Exception as e:
              print(f'âŒ Error: {str(e)}')
              exit(1)
          EOF
      
      - name: ğŸ“¤ Commit Excel
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ“Š Update Orders.xlsx from orders.jsonl'
          file_pattern: 'data/Orders.xlsx'
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false

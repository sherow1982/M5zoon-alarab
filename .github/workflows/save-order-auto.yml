name: ğŸ“ Save Order

on:
  repository_dispatch:
    types: [save_order]
  workflow_dispatch:
    inputs:
      orderId:
        description: 'Order ID'
        required: true
      fullName:
        description: 'Customer Name'
        required: true
      phone:
        description: 'Phone'
        required: true
      city:
        description: 'City'
        required: true
      items:
        description: 'Items'
        required: true
      total:
        description: 'Total'
        required: true
      date:
        description: 'Date'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  save_order:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ“ Create Orders Directory
        run: mkdir -p orders
      
      - name: ğŸ“ Extract Order Data
        id: order
        run: |
          ORDER_ID="${{ github.event.client_payload.orderId || inputs.orderId }}"
          FULL_NAME="${{ github.event.client_payload.fullName || inputs.fullName }}"
          PHONE="${{ github.event.client_payload.phone || inputs.phone }}"
          CITY="${{ github.event.client_payload.city || inputs.city }}"
          ITEMS="${{ github.event.client_payload.items || inputs.items }}"
          TOTAL="${{ github.event.client_payload.total || inputs.total }}"
          DATE="${{ github.event.client_payload.date || inputs.date }}"
          TIMESTAMP=$(date +%s000)
          
          echo "order_id=${ORDER_ID}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Save JSON Order
        run: |
          mkdir -p orders
          cat > "orders/${{ steps.order.outputs.order_id }}-${{ steps.order.outputs.timestamp }}.json" << 'EOF'
          {
            "orderId": "${{ github.event.client_payload.orderId || inputs.orderId }}",
            "fullName": "${{ github.event.client_payload.fullName || inputs.fullName }}",
            "phone": "${{ github.event.client_payload.phone || inputs.phone }}",
            "city": "${{ github.event.client_payload.city || inputs.city }}",
            "items": "${{ github.event.client_payload.items || inputs.items }}",
            "total": "${{ github.event.client_payload.total || inputs.total }}",
            "date": "${{ github.event.client_payload.date || inputs.date }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          echo "âœ… JSON saved"
      
      - name: ğŸ“Š Update CSV
        run: |
          CSV_FILE="orders/new-orders.csv"
          
          # Create header if not exists
          if [ ! -f "$CSV_FILE" ]; then
            printf "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©,Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„ØªØ§Ø±ÙŠØ®\n" > "$CSV_FILE"
          fi
          
          # Add new order row
          ORDER_ID="${{ github.event.client_payload.orderId || inputs.orderId }}"
          FULL_NAME="${{ github.event.client_payload.fullName || inputs.fullName }}"
          PHONE="${{ github.event.client_payload.phone || inputs.phone }}"
          CITY="${{ github.event.client_payload.city || inputs.city }}"
          ITEMS="${{ github.event.client_payload.items || inputs.items }}"
          TOTAL="${{ github.event.client_payload.total || inputs.total }}"
          DATE="${{ github.event.client_payload.date || inputs.date }}"
          
          # Escape quotes in items
          ITEMS_ESCAPED="${ITEMS//\"/\"\"}"
          
          echo "$ORDER_ID,$FULL_NAME,$PHONE,$CITY,\"$ITEMS_ESCAPED\",$TOTAL,$DATE" >> "$CSV_FILE"
          echo "âœ… CSV updated"
      
      - name: ğŸ”§ Git Config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ğŸ“¤ Commit & Push
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add orders/
            git commit -m "ğŸ New order: ${{ github.event.client_payload.orderId || inputs.orderId }}"
            git push origin main
            echo "âœ… Changes pushed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: âœ… Done
        run: |
          echo "Order saved successfully!"
          echo "Order ID: ${{ github.event.client_payload.orderId || inputs.orderId }}"
          echo "Customer: ${{ github.event.client_payload.fullName || inputs.fullName }}"

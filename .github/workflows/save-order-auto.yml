name: ğŸ“ Save Order

on:
  repository_dispatch:
    types: [save_order]
  workflow_dispatch:
    inputs:
      orderId:
        description: 'Order ID'
        required: true
      fullName:
        description: 'Customer Name'
        required: true
      phone:
        description: 'Phone'
        required: true
      city:
        description: 'City'
        required: true
      items:
        description: 'Items'
        required: true
      total:
        description: 'Total'
        required: true
      date:
        description: 'Date'
        required: true

jobs:
  save_order:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“ Extract Order Data
        id: order
        run: |
          ORDER_ID="${{ github.event.client_payload.orderId || inputs.orderId }}"
          FULL_NAME="${{ github.event.client_payload.fullName || inputs.fullName }}"
          PHONE="${{ github.event.client_payload.phone || inputs.phone }}"
          CITY="${{ github.event.client_payload.city || inputs.city }}"
          ITEMS="${{ github.event.client_payload.items || inputs.items }}"
          TOTAL="${{ github.event.client_payload.total || inputs.total }}"
          DATE="${{ github.event.client_payload.date || inputs.date }}"
          TIMESTAMP=$(date +%s%3N)
          
          echo "order_id=${ORDER_ID}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "full_name=${FULL_NAME}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š Append Order to Data File
        run: |
          DATA_FILE="data/orders.jsonl"
          mkdir -p data
          
          ORDER_ID="${{ github.event.client_payload.orderId || inputs.orderId }}"
          FULL_NAME="${{ github.event.client_payload.fullName || inputs.fullName }}"
          PHONE="${{ github.event.client_payload.phone || inputs.phone }}"
          CITY="${{ github.event.client_payload.city || inputs.city }}"
          ITEMS="${{ github.event.client_payload.items || inputs.items }}"
          TOTAL="${{ github.event.client_payload.total || inputs.total }}"
          DATE="${{ github.event.client_payload.date || inputs.date }}"
          
          # Escape special characters for JSON
          ITEMS_ESCAPED="$(echo "${ITEMS}" | sed 's/"/\\&/g')"
          
          # Write as JSONL (one line per order)
          echo "{\"orderId\":\"${ORDER_ID}\",\"fullName\":\"${FULL_NAME}\",\"phone\":\"${PHONE}\",\"city\":\"${CITY}\",\"items\":\"${ITEMS_ESCAPED}\",\"total\":\"${TOTAL}\",\"date\":\"${DATE}\",\"savedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" >> "${DATA_FILE}"
          echo "âœ… Order saved to data/orders.jsonl"
      
      - name: ğŸ“¤ Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ New order: ${{ github.event.client_payload.orderId || inputs.orderId }}"
          file_pattern: "data/orders.jsonl"
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
      
      - name: âœ… Done
        run: |
          echo "Order saved successfully!"
          echo "Order ID: ${{ github.event.client_payload.orderId || inputs.orderId }}"
          echo "Customer: ${{ steps.order.outputs.full_name }}"

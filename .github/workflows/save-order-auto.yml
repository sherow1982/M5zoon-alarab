name: ğŸ Auto-Save Order

on:
  repository_dispatch:
    types: [save_order]
  workflow_dispatch:
    inputs:
      orderId:
        description: 'Order ID'
        required: true
      fullName:
        description: 'Customer Name'
        required: true
      phone:
        description: 'Phone'
        required: true
      city:
        description: 'City'
        required: true
      items:
        description: 'Items'
        required: true
      total:
        description: 'Total'
        required: true
      date:
        description: 'Date'
        required: true

jobs:
  save_order:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”¤ Prepare Order Data
        id: prepare
        run: |
          # Ù…Ù† webhook dispatch
          ORDER_ID="${{ github.event.client_payload.orderId || github.event.inputs.orderId }}"
          FULL_NAME="${{ github.event.client_payload.fullName || github.event.inputs.fullName }}"
          PHONE="${{ github.event.client_payload.phone || github.event.inputs.phone }}"
          CITY="${{ github.event.client_payload.city || github.event.inputs.city }}"
          ITEMS="${{ github.event.client_payload.items || github.event.inputs.items }}"
          TOTAL="${{ github.event.client_payload.total || github.event.inputs.total }}"
          DATE="${{ github.event.client_payload.date || github.event.inputs.date }}"
          
          echo "ORDER_ID=$ORDER_ID" >> $GITHUB_ENV
          echo "FULL_NAME=$FULL_NAME" >> $GITHUB_ENV
          echo "PHONE=$PHONE" >> $GITHUB_ENV
          echo "CITY=$CITY" >> $GITHUB_ENV
          echo "ITEMS=$ITEMS" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +%s000)" >> $GITHUB_ENV
      
      - name: ğŸ“ Create Orders Directory
        run: mkdir -p orders
      
      - name: ğŸ“ Create JSON File
        run: |
          cat > "orders/${ORDER_ID#\#}-${TIMESTAMP}.json" << 'JSONEOF'
{
  "orderId": "${{ env.ORDER_ID }}",
  "fullName": "${{ env.FULL_NAME }}",
  "phone": "${{ env.PHONE }}",
  "city": "${{ env.CITY }}",
  "items": "${{ env.ITEMS }}",
  "total": "${{ env.TOTAL }}",
  "date": "${{ env.DATE }}",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
JSONEOF
          cat "orders/${ORDER_ID#\#}-${TIMESTAMP}.json"
      
      - name: ğŸ“Š Update CSV File
        run: |
          CSV_FILE="orders/new-orders.csv"
          ORDER_ID="${{ env.ORDER_ID }}"
          FULL_NAME="${{ env.FULL_NAME }}"
          PHONE="${{ env.PHONE }}"
          CITY="${{ env.CITY }}"
          ITEMS="${{ env.ITEMS }}"
          TOTAL="${{ env.TOTAL }}"
          DATE="${{ env.DATE }}"
          
          # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
          if [ ! -f "$CSV_FILE" ]; then
            echo "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©,Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„ØªØ§Ø±ÙŠØ®" > "$CSV_FILE"
          fi
          
          # Ø£Ø¶ÙŠÙ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          # Ø­ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØµÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ CSV
          ITEMS_ESCAPED="${ITEMS//\"/\"\"}"
          
          echo '"'"$ORDER_ID"'",'"$FULL_NAME"',"$PHONE",'"$CITY"','"'"$ITEMS_ESCAPED"'"','"$TOTAL"','"$DATE"'" >> "$CSV_FILE"
          
          echo "âœ… CSV Updated:"
          tail -1 "$CSV_FILE"
      
      - name: ğŸ”„ Git Config
        run: |
          git config user.name "emirates-bot"
          git config user.email "bot@emirates-gifts.local"
      
      - name: ğŸ’¾ Commit & Push
        run: |
          git add orders/
          git commit -m "ğŸ New order: ${{ env.ORDER_ID }}" || echo "Nothing to commit"
          git push || echo "Nothing to push"
      
      - name: âœ… Complete
        run: |
          echo "âœ… Order processed successfully!"
          echo "ğŸ“¦ Order ID: ${{ env.ORDER_ID }}"
          echo "ğŸ‘¤ Customer: ${{ env.FULL_NAME }}"
          echo "ğŸ“ City: ${{ env.CITY }}"
          echo "ğŸ’° Total: ${{ env.TOTAL }}"

name: ğŸ“ Process Orders (CSV â†’ Excel)

on:
  repository_dispatch:
    types: [save_order]
  workflow_dispatch:

jobs:
  process_orders:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install pandas & openpyxl
        run: pip install pandas openpyxl
      
      - name: ğŸ’¨ Save Order to CSV
        run: |
          python3 << 'EOF'
          import json
          import csv
          import os
          from datetime import datetime
          
          # Get order from GitHub event
          order_data = {
              'orderId': '${{ github.event.client_payload.orderId }}',
              'fullName': '${{ github.event.client_payload.fullName }}',
              'phone': '${{ github.event.client_payload.phone }}',
              'city': '${{ github.event.client_payload.city }}',
              'items': '${{ github.event.client_payload.items }}',
              'total': '${{ github.event.client_payload.total }}',
              'date': '${{ github.event.client_payload.date }}'
          }
          
          csv_file = 'data/orders.csv'
          os.makedirs('data', exist_ok=True)
          
          # Check if file exists
          file_exists = os.path.isfile(csv_file)
          
          with open(csv_file, 'a', newline='', encoding='utf-8') as f:
              writer = csv.DictWriter(f, fieldnames=[
                  'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù‡Ø§ØªÙ', 
                  'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 
                  'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'
              ])
              
              if not file_exists:
                  writer.writeheader()
              
              writer.writerow({
                  'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨': order_data.get('orderId', ''),
                  'Ø§Ù„Ø§Ø³Ù…': order_data.get('fullName', ''),
                  'Ø§Ù„Ù‡Ø§ØªÙ': order_data.get('phone', ''),
                  'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': order_data.get('city', ''),
                  'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª': order_data.get('items', ''),
                  'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': order_data.get('total', ''),
                  'Ø§Ù„ØªØ§Ø±ÙŠØ®': order_data.get('date', '')
              })
          
          print('âœ… CSV updated')
          EOF
      
      - name: ğŸ“Š Convert CSV to Excel
        run: |
          python3 << 'EOF'
          import pandas as pd
          import os
          
          csv_file = 'data/orders.csv'
          excel_file = 'data/Orders.xlsx'
          
          if os.path.isfile(csv_file):
              # Read CSV
              df = pd.read_csv(csv_file, encoding='utf-8')
              
              # Save to Excel
              os.makedirs('data', exist_ok=True)
              df.to_excel(excel_file, index=False, sheet_name='Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª')
              
              print(f'âœ… Excel file created: {excel_file}')
              print(f'ğŸ“Š Total orders: {len(df)}')
          else:
              print('âš ï¸ No CSV file found')
          EOF
      
      - name: ğŸ“¤ Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ“ Add order: ${{ github.event.client_payload.orderId }}'
          file_pattern: 'data/*'
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
      
      - name: âœ… Done
        run: |
          echo 'âœ… Order processed successfully!'
          echo 'ğŸ“ CSV: data/orders.csv'
          echo 'ğŸ“Š Excel: data/Orders.xlsx'
